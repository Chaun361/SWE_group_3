<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="cart.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
        </nav>
    </header>

    <main class="container">
        <h1 class="page-title">Your Cart</h1>

        <div class="cart-layout">
            
            <div class="cart-items" id="cart-items-container">
                <p style="text-align: center;">Loading cart items...</p>
            </div>

            <div class="cart-summary">
                <h2>Order Summary</h2>
                <div class="summary-line">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">0 ‡∏ø</span>
                </div>
                <div class="summary-line">
                    <span>Shipping</span>
                    <span id="summary-shipping">Free</span>
                </div>
                <div class="summary-line total">
                    <span>Total Price</span>
                    <span id="summary-total">0 ‡∏ø</span>
                </div>
                
                <button class="submit-btn checkout-btn"><a href="checkout.html">Checkout</a></button>
            </div>
            
        </div>
    </main>
    
    <script>
    // API Endpoints
    const CART_API_ENDPOINT = 'http://localhost:8080/api/cart/';
    const CHECKOUT_PAGE = 'checkout.html';
    const LOGIN_PAGE = 'login.html';
    let currentCartData = []; 

    // ----------------------------------------------------------------
    // 1. HEADER LOGIC (Unchanged)
    // ----------------------------------------------------------------
    function updateHeader() {
        const username = sessionStorage.getItem('username');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        const linksContainer = document.getElementById('header-auth-links');
        const mockCartCount = sessionStorage.getItem('mockCartCount') || '0';

        if (!isLogin || !username) { 
            window.location.href = LOGIN_PAGE; 
            return false; 
        }
        
        linksContainer.innerHTML = `
            <a href="index.html" class="nav-link">HOME</a>
            <a href="order-history.html" class="nav-link">Order History</a>
            <a href="profile.html" class="nav-link">${username} üë§</a>
            <a href="cart.html" class="nav-link cart-icon">üõí (${mockCartCount})</a> 
        `;
        return true;
    }

    // ----------------------------------------------------------------
    // 2. RENDERING LOGIC & RECALCULATION
    // ----------------------------------------------------------------
    
    function calculateAndRenderSummary() {
        const summarySubtotal = document.getElementById('summary-subtotal');
        const summaryTotal = document.getElementById('summary-total');
        
        let subtotal = 0;
        const shippingFee = 0.00; 
        
        currentCartData.forEach(item => {
            subtotal += item.itemTotalPrice;
        });

        const total = subtotal + shippingFee;
        
        summarySubtotal.textContent = subtotal.toLocaleString() + ' ‡∏ø';
        summaryTotal.textContent = total.toLocaleString() + ' ‡∏ø';

        document.querySelector('.checkout-btn').disabled = (subtotal === 0);
    }
    
    /**
     * (REVISED) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà
     */
    function renderCartItems(cartItems) {
        const container = document.getElementById('cart-items-container');
        container.innerHTML = '';
        currentCartData = cartItems; // Update Global Data Store

        if (!cartItems || cartItems.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 20px;">Your cart is empty.</p>';
            document.querySelector('.checkout-btn').disabled = true;
            document.getElementById('summary-subtotal').textContent = '0 ‡∏ø';
            document.getElementById('summary-total').textContent = '0 ‡∏ø';
            return;
        }

        cartItems.forEach(item => {
            
            // (FIXED) ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ HTML ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå
            const itemHtml = `
                <div class="cart-item-row"> 
                    
                    <div class="item-img">
                        <img src="${item.productImage || 'images/placeholder.png'}" alt="${item.productName}">
                    </div>
                    
                    <div class="item-details">
                        <p class="item-name">${item.productName}</p>
                        <p class="item-price">${item.itemPrice.toLocaleString()} ‡∏ø</p>
                        
                        <div class="item-quantity-controls">
                            <button 
                                class="quantity-btn minus-btn" 
                                onclick="handleUpdateQuantity(${item.productId}, -1)"
                                ${item.quantity <= 1 ? 'disabled' : ''}
                            >-</button>
                            
                            <input 
                                type="text" 
                                class="quantity-input" 
                                value="${item.quantity}" 
                                readonly 
                            >
                            
                            <button 
                                class="quantity-btn plus-btn" 
                                onclick="handleUpdateQuantity(${item.productId}, 1)"
                            >+</button>
                        </div>
                        
                        <a 
                            href="#" 
                            class="item-remove-link" 
                            onclick="event.preventDefault(); handleRemoveItem(${item.productId}, ${item.quantity})"
                        >Remove</a>
                    </div>

                </div>
            `;
            container.innerHTML += itemHtml;
        });
        
        calculateAndRenderSummary();
    }

    // ----------------------------------------------------------------
    // 3. (REVISED) CART ACTION LOGIC (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend)
    // ----------------------------------------------------------------

    function showLoading() {
        const container = document.getElementById('cart-items-container');
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Updating cart...</p>';
    }

    /**
     * (NEW) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API (add ‡∏´‡∏£‡∏∑‡∏≠ remove)
     */
    async function updateCartAPI(action, productId, quantity) {
        const userId = sessionStorage.getItem('userId');
        if (!userId) {
            alert('Session expired. Please log in.');
            window.location.href = LOGIN_PAGE;
            return;
        }

        showLoading();
        const API_URL = `${CART_API_ENDPOINT}${action}?userId=${userId}&productId=${productId}&quantity=${quantity}`;

        try {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏î‡πâ‡∏ß‡∏¢ Method POST ‡∏ï‡∏≤‡∏° Task
            const response = await fetch(API_URL, {
                method: 'POST'
            });

            if (!response.ok) {
                // (FIXED) ‡∏≠‡πà‡∏≤‡∏ô Error message ‡∏à‡∏≤‡∏Å response
                const errorText = await response.text(); 
                let errorMessage = `Failed to update cart: ${response.status}`;
                
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                     // ‡∏ñ‡πâ‡∏≤ Error ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON
                    if (response.status === 405) { // 405 = Method Not Allowed
                         errorMessage = `Method 'POST' is not supported by the server. Please check Backend.`;
                    }
                }
                
                throw new Error(errorMessage);
            }

            await fetchAndRenderCart(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        } catch (error) {
            console.error(`Error updating cart (${action}):`, error);
            alert(`Error: ${error.message}\nPlease try again.`);
            await fetchAndRenderCart(); // ‡∏ñ‡πâ‡∏≤ Error ‡∏Å‡πá‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        }
    }

    /**
     * (NEW) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° + ‡∏´‡∏£‡∏∑‡∏≠ -
     */
    function handleUpdateQuantity(productId, quantityChange) {
        if (quantityChange > 0) {
            updateCartAPI('add', productId, 1);
        } else {
            updateCartAPI('remove', productId, 1);
        }
    }

    /**
     * (NEW) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° 'Remove' (X)
     */
    function handleRemoveItem(productId, totalQuantity) {
        if (confirm(`Are you sure you want to remove all ${totalQuantity} of this item(s) from your cart?`)) {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API 'remove' ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
            updateCartAPI('remove', productId, totalQuantity);
        }
    }

    // (DELETED) - ‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 'saveCartToSession' ‡πÅ‡∏•‡∏∞ 'updateQuantity' ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á

    // ----------------------------------------------------------------
    // 4. DATA FETCHING (Source of Truth is Backend)
    // ----------------------------------------------------------------
    async function fetchAndRenderCart() {
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        if (!isLogin || !userId) {
            alert('Please log in to view your cart.');
            window.location.href = LOGIN_PAGE; 
            return;
        }

        try {
            const response = await fetch(CART_API_ENDPOINT + userId); 

            if (!response.ok) {
                if (response.status === 404) {
                    renderCartItems([]); 
                    return;
                }
                throw new Error(`Failed to fetch cart data: ${response.status}`);
            }

            const cartData = await response.json();
            
            if (!cartData || !cartData.items || cartData.items.length === 0) {
                renderCartItems([]);
            } else {
                renderCartItems(cartData.items);
            }
            
            // (FIXED) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ô Header ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            const newCartCount = (cartData.items || []).reduce((sum, item) => sum + item.quantity, 0);
            sessionStorage.setItem('mockCartCount', newCartCount.toString());
            updateHeader(); 

        } catch (error) {
            console.error('Cart Load Error:', error);
            const container = document.getElementById('cart-items-container');
            container.innerHTML = 
                '<p style="color: red; text-align: center; padding: 20px;">Could not load cart data. Please try again.</p>';
        }
    }

    // (DELETED) - ‡∏•‡∏ö Section 5 'removeFromCart' (‡πÅ‡∏ö‡∏ö DELETE) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á

    // ----------------------------------------------------------------
    // 6. INITIALIZATION
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const loggedIn = updateHeader();
        if (loggedIn) {
            fetchAndRenderCart();
        }
    });
    </script>
</body>
</html>