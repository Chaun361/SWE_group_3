<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="cart.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <a href="index.html" class="index">home</a>
        <nav class="auth-links" id="header-auth-links">
        </nav>
    </header>

     <main class="container">
        <h1 class="page-title">Your Cart</h1>

        <div class="cart-layout">

            <div class="cart-items" id="cart-items-container">
                <p class="empty-cart">Loading cart items...</p>
            </div>

            <div class="cart-summary">
                <h2>Order Summary</h2>
                <div class="summary-line">
                    <span>subtotal</span>
                    <span id="summary-subtotal">6000.00 Baht</span>
                </div>
                <div class="summary-line">
                    <span>shipping</span>
                    <span id="summary-shipping">Free</span>
                </div>
                <div class="summary-line total">
                    <span>Total</span>
                    <span id="summary-total">6000.00 Baht</span>
                </div>

                <button class="checkout-btn" id="checkout-button">
                    <a href="checkout.html">Checkout</a>
                </button>
            </div>

        </div>
    </main>

    <script>
    // API Endpoints
Â  Â  const CART_API_ENDPOINT = 'http://localhost:8080/api/cart/';
Â  Â  const IMAGE_BASE_URL = "http://localhost:8080/api/images/";
Â  Â  const CHECKOUT_PAGE = 'checkout.html';
Â  Â  const LOGIN_PAGE = 'login.html';
Â  Â  let currentCartData = [];


Â  Â  // ----------------------------------------------------------------
Â  Â  // HEADER LOGIC
Â  Â  // ----------------------------------------------------------------
Â  Â  function updateHeader(cartItems = []) {
Â  Â  Â  Â  const username = sessionStorage.getItem('username');
Â  Â  Â  Â  const isLogin = sessionStorage.getItem('isLogin') === 'true';
Â  Â  Â  Â  const linksContainer = document.getElementById('header-auth-links');
Â  Â  Â  Â  const realCartCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);

Â  Â  Â  Â  if (!isLogin || !username) { 
Â  Â  Â  Â  Â  Â  linksContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="nav-link">home</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="nav-link">order history</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="nav-link">customer's name ğŸ‘¤</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="nav-link">ğŸ›’ (${realCartCount})</a>
Â  Â  Â  Â  Â  Â  `;
            return true;
Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  linksContainer.innerHTML = `
Â  Â  Â  Â  Â  <a href="order-history.html" class="nav-link">order history</a>
Â  Â  Â  Â  Â  <a href="profile.html" class="nav-link">${username} ğŸ‘¤</a>
Â  Â  Â  Â  Â  <a href="cart.html" class="nav-link">ğŸ›’ (${realCartCount})</a>
Â  Â  Â  Â  Â `;
        return true;
Â  Â Â }
Â  Â  Â  Â 
Â  Â  

Â  Â  // ----------------------------------------------------------------
Â  Â  // RENDERING LOGIC
Â  Â  // ----------------------------------------------------------------

Â  Â  function calculateAndRenderSummary() {
Â  Â  Â  Â  const summarySubtotal = document.getElementById('summary-subtotal');
Â  Â  Â  Â  const summaryTotal = document.getElementById('summary-total');
Â  Â  Â  Â  let subtotal = 0;
Â  Â  Â  Â  const shippingFee = 0.00;

Â  Â  Â  Â  currentCartData.forEach(item => {
Â  Â  Â  Â  Â  Â  const itemTotal = item.subtotal || item.itemTotalPrice || 0;
Â  Â  Â  Â  Â  Â  subtotal += itemTotal;
Â  Â  Â  Â  });

Â  Â  Â  Â  const total = subtotal + shippingFee;
Â  Â  Â  Â  const formatOptions = {
Â  Â  Â  Â  Â  Â  style: 'decimal',
Â  Â  Â  Â  Â  Â  minimumFractionDigits: 2,
Â  Â  Â  Â  Â  Â  maximumFractionDigits: 2
Â  Â  Â  Â  };
Â  Â  Â  Â  summarySubtotal.textContent = subtotal.toLocaleString('en-US', formatOptions) + ' Baht';
Â  Â  Â  Â  summaryTotal.textContent = total.toLocaleString('en-US', formatOptions) + ' Baht';
Â  Â  Â  Â  document.getElementById('checkout-button').disabled = (subtotal === 0);
Â  Â  }
Â  Â  
Â  Â  function renderCartItems(cartItems) {
Â  Â  Â  Â  const container = document.getElementById('cart-items-container');
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  currentCartData = cartItems;

Â  Â  Â  Â  if (!cartItems || cartItems.length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<p class="empty-cart">Your cart is empty.</p>';
Â  Â  Â  Â  Â  Â  calculateAndRenderSummary(); // à¸„à¸³à¸™à¸§à¸“à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™ 0
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  cartItems.forEach((item) => {
Â  Â  Â  Â  Â  Â  const itemName = item.name || item.productName || 'Unnamed Product';
            const itemPrice = item.price || item.itemPrice || 0;

            const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  itemDiv.className = 'cart-item';
Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `
                <div class="item-img">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="./images/${item.productId}.jpg" alt="${itemName}">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
                <div class="item-details">
                    <p class="item-name">${itemName}</p> 
                    <p class="item-price">${itemPrice.toLocaleString('en-US', { minimumFractionDigits: 2 })} Baht</p>
                </div>
                <div class="item-actions">
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="handleUpdateQuantity(${item.productId}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>âˆ’</button>
                        <div class="quantity-display" id="qty-${item.productId}">${item.quantity}</div>
                        <button class="quantity-btn" onclick="handleUpdateQuantity(${item.productId}, 1)">+</button>
                    </div>
                    <button class="remove-btn" onclick="handleRemoveItem(${item.productId}, ${item.quantity})">Remove</button>
                </div>
            `;
            container.appendChild(itemDiv);
        });
        calculateAndRenderSummary();
Â  Â  }

Â  Â  // ----------------------------------------------------------------
Â  Â  // CART ACTION LOGIC
Â  Â  // ----------------------------------------------------------------
    async function updateCartAPI(action, productId, quantity) {
        // (à¸ªà¸¡à¸¡à¸•à¸´à¸§à¹ˆà¸² 'userId' à¸–à¸¹à¸à¹€à¸‹à¸Ÿà¹„à¸§à¹‰à¹ƒà¸™ session à¸•à¸­à¸™ login)
        const userId = sessionStorage.getItem('userId'); 
        if (!userId) {
            alert('Session expired. Please log in.');
            window.location.href = LOGIN_PAGE;
            return;
        }

        document.getElementById('cart-items-container').innerHTML = '<p class="empty-cart">Updating cart...</p>';
        
        const API_URL = `${CART_API_ENDPOINT}${action}?userId=${userId}&productId=${productId}&quantity=${quantity}`;

        try {
            // (DoD 1 & 2) "à¸¢à¸´à¸‡" POST à¹„à¸›à¸—à¸µà¹ˆ Backend
            const response = await fetch(API_URL, {
                method: 'POST'
            });

            if (!response.ok) {
                // (à¸–à¹‰à¸² Backend à¸•à¸­à¸š 405 "Method Not Allowed" à¸«à¸£à¸·à¸­ 500)
                const errorText = await response.text();
                throw new Error(errorText || `Failed to ${action} item`);
            }
            
            // (DoD 3) "Merge" (à¸‹à¸´à¸‡à¸à¹Œ)
            // à¸–à¹‰à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ... "à¹‚à¸«à¸¥à¸”à¸•à¸°à¸à¸£à¹‰à¸²à¹ƒà¸«à¸¡à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”" à¸ˆà¸²à¸ Server
            console.log(`Successfully ${action}ed item. Refreshing cart...`);
            await fetchAndRenderCart();

        } catch (error) {
            console.error(`Error updating cart (${action}):`, error);
            let friendlyMessage;
            if (error.message && error.message.includes('StockException')) {
                const failedItem = currentCartData.find(item => item.productId === productId);
                
                if (failedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const productName = failedItem.name || failedItem.productName || 'This item';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  friendlyMessage = `${productName} out of stock!`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  friendlyMessage = 'Sorry! That item is currently out of stock.';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  friendlyMessage = `Error updating cart. Please try again.\n(${error.message})`;
Â  Â  Â  Â  Â  Â  }

            alert(friendlyMessage);
            await fetchAndRenderCart(); 
        }
    }

    function handleUpdateQuantity(productId, quantityChange) {
        if (quantityChange > 0) {
            // (DoD 1) à¹€à¸à¸´à¹ˆà¸¡ 1 à¸Šà¸´à¹‰à¸™
            updateCartAPI('add', productId, 1);
        } else {
            // (DoD 1) à¸¥à¸š 1 à¸Šà¸´à¹‰à¸™
            updateCartAPI('remove', productId, 1);
        }
    }

    async function handleRemoveItem(productId, totalQuantity) {
        // (DoD 2) à¸¥à¸šà¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        if (confirm(`Are you sure you want to remove all ${totalQuantity} of this item(s) from your cart?`)) {
            updateCartAPI('remove', productId, totalQuantity);
        }
    }

Â  Â  // ----------------------------------------------------------------
Â  Â  // DATA FETCHING
Â  Â  // ----------------------------------------------------------------
Â  Â  
Â  Â  async function fetchAndRenderCart() {
        console.log('Fetching cart from "Source of Truth" (Backend API)...');
        const userId = sessionStorage.getItem('userId');
        
        // (FIX) "à¹‚à¸à¸‡" à¸£à¸°à¸šà¸š... à¸–à¹‰à¸² Login à¹„à¸¡à¹ˆà¹„à¸”à¹‰... à¹ƒà¸«à¹‰à¸¢à¸±à¸” userId à¸›à¸¥à¸­à¸¡
        if (!userId) {
             console.warn('No userId found! HACK: Injecting userId=1 for testing.');
             sessionStorage.setItem('userId', '1'); // <-- (à¸™à¸µà¹ˆà¸„à¸·à¸­ "à¸à¸²à¸£à¹‚à¸à¸‡" à¸—à¸µà¹ˆà¹€à¸£à¸²à¸„à¸¸à¸¢à¸à¸±à¸™)
             sessionStorage.setItem('username', 'max');
             sessionStorage.setItem('isLogin', 'true');
             // (à¹€à¸£à¸µà¸¢à¸à¸•à¸±à¸§à¹€à¸­à¸‡à¸‹à¹‰à¸³... à¹à¸•à¹ˆà¸„à¸£à¸²à¸§à¸™à¸µà¹‰à¸ˆà¸°à¸¡à¸µ userId à¹à¸¥à¹‰à¸§)
             fetchAndRenderCart();
             return;
        }
        
        const container = document.getElementById('cart-items-container');

        try {
            // 1. "à¸¢à¸´à¸‡" GET à¹„à¸›à¸—à¸µà¹ˆ Backend
            const response = await fetch(CART_API_ENDPOINT + userId); 
            if (!response.ok) {
                if (response.status === 404) {
                    console.log('Cart not found (404). Rendering empty cart.');
                    renderCartItems([]);
                    updateHeader([]);
                    return;
                }
                throw new Error(`Failed to fetch cart data: ${response.status}`);
            }

            const cartData = await response.json();
            
            // 2. à¸–à¹‰à¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ... à¸ªà¹ˆà¸‡ "à¸‚à¸­à¸‡à¸ˆà¸£à¸´à¸‡" (cartData.items) à¹„à¸›à¸§à¸²à¸”
            if (!cartData || !cartData.items || cartData.items.length === 0) {
                renderCartItems([]);
                updateHeader([]);
            } else {
                renderCartItems(cartData.items);
                // (FIX) à¸ªà¹ˆà¸‡ "à¸‚à¸­à¸‡à¸ˆà¸£à¸´à¸‡" à¹„à¸›à¸­à¸±à¸›à¹€à¸”à¸• Header à¸”à¹‰à¸§à¸¢
                updateHeader(cartData.items);
            }

        } catch (error) {
            console.error('Cart Load Error:', error);
            container.innerHTML = `<p class="empty-cart" style="color: red;">Could not load cart data. ${error.message}</p>`;
        }
    }
Â  Â  
Â  Â  // ----------------------------------------------------------------
Â  Â  // INITIALIZATION
Â  Â  // ----------------------------------------------------------------
Â  Â  window.addEventListener('pageshow', (event) => {
        // (à¹ƒà¸Šà¹‰ pageshow à¹€à¸à¸·à¹ˆà¸­à¹à¸à¹‰à¸šà¸±à¹Šà¸à¸›à¸¸à¹ˆà¸¡ Back)
        console.log("Page is visible: Running update.");
        fetchAndRenderCart();
    });
    </script>
</body>
</html>