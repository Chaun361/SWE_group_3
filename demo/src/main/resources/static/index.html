<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
        <section class="welcome-section" id="welcome-section">
            <h1>Welcome</h1>
            </section>

        <section class="products-grid" id="products-grid">
            <p style="text-align: center; padding: 20px;">Loading products...</p>
        </section>

    </main>

    // ... (ส่วน MOCK_PRODUCTS และ API ENDPOINTS เดิม) ...
    const CART_COUNT_API = '/api/cart/items/count'; // API Mock สำหรับนับจำนวน
    
    // Global variable to mock the cart count
    let currentCartCount = 0; 

    // ----------------------------------------------------------------
    // 4. NEW CART COUNT LOGIC (Task 2)
    // ----------------------------------------------------------------
    
    // ฟังก์ชันดึงจำนวนสินค้าในตะกร้า (Mock Logic)
    async function fetchCartCount() {
        const userId = sessionStorage.getItem('userId');
        const countElement = document.getElementById('cart-count');
        
        if (!userId || !countElement) return;

        try {
            // Mock API call to /api/cart/items/count
            // ใน Mock เราจะใช้ค่าที่เก็บใน currentCartCount แทนการ fetch
            // ในสถานการณ์จริง: fetch(CART_COUNT_API + '?userId=' + userId) 
            
            // ใช้ค่าจาก currentCartCount ที่ถูกอัปเดตด้วย Add to Cart
            const count = currentCartCount; 
            
            countElement.textContent = count.toString(); 

        } catch (error) {
            console.error('Fetch Cart Count Error:', error);
            if (countElement) countElement.textContent = '?';
        }
    }
    
    // ----------------------------------------------------------------
    // 5. HANDLE ADD TO CART LOGIC (แก้ไขเพื่อให้มีการอัปเดตจำนวน)
    // ----------------------------------------------------------------

    async function handleAddToCart(e) {
        // ... (โค้ดตรวจสอบ Login และดึง productId เดิม) ...
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        if (!isLogin || !userId) {
            alert('Please log in to add items to your cart.');
            return;
        }

        const button = e.target;
        const productId = button.getAttribute('data-product-id');

        if (!productId) return;

        // ... (โค้ด Mock Fetch เดิม) ...
        try {
            const response = await fetch(ADD_TO_CART_MOCK_ENDPOINT);
            const data = await response.json();
            
            // Mock Error Scenario (สมมติว่าถ้า productId เป็น 9 จะ Out of Stock)
            if (productId === '9') { 
                alert("Product not found / Out of stock"); 
                return;
            }
            
            if (data.success) {
                alert(`Product added to cart successfully! (Product ID: ${productId})`);
                
                // ********************
                // * เพิ่มส่วนนี้: อัปเดต Cart Count *
                // ********************
                currentCartCount += QUANTITY; // เพิ่มจำนวนสินค้าในตะกร้า
                fetchCartCount(); // อัปเดตการแสดงผลบน Header ทันที

            } else {
                alert(data.message || "An unknown error occurred during add to cart."); 
            }

        } catch (error) {
            console.error('Add to Cart Error:', error);
            alert('Server/Mock connection error. Cannot add item to cart.');
        }
    }

    // ... (ส่วน setupAddToCartHandlers และ updateHeaderAndWelcome เดิม) ...

    // ----------------------------------------------------------------
    // 6. INITIALIZATION (แก้ไขส่วนนี้)
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        // ... (โค้ดเรียก updateHeaderAndWelcome และ fetchAndDisplayProducts เดิม) ...
        updateHeaderAndWelcome();
        fetchAndDisplayProducts(); 
        setupAddToCartHandlers(); 
        // NOTE: fetchCartCount ถูกเรียกอยู่แล้วภายใน updateHeaderAndWelcome เมื่อ login
    });
</body>
</html>