<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
    
    <section class="welcome-section" id="welcome-section">
        <h1>Welcome</h1>
        </section>

    <h2 class="products-title">Products</h2> 
    
    <section class="products-grid" id="products-grid">
        </section>

    </main>
<script>
    // ----------------------------------------------------------------
    // 0. CONFIGURATION & ENDPOINTS
    // ----------------------------------------------------------------
    const LOGIN_PAGE = 'login.html';
    // *** ปรับปรุง: ใช้ API Endpoint จริงจาก Spring Boot Server ***
    const API_PRODUCT_ENDPOINT = 'http://localhost:8080/api/products';  
    
    // Endpoint ที่ควรเปลี่ยนในภายหลัง (ถ้าทำจริง)
    const ADD_TO_CART_API = 'http://localhost:8080/api/cart/add'; 
    const GET_CART_COUNT_API = 'http://localhost:8080/api/cart/count'; 

    // Endpoint Mock สำหรับ Task นี้ (ใช้เพื่อจำลองการเพิ่มสินค้า)
    const ADD_TO_CART_MOCK_ENDPOINT = 'mock/add_to_cart.json'; 
    const GET_CART_COUNT_MOCK_ENDPOINT = 'mock/cart_count.json';

    const QUANTITY = 1; 

    // ----------------------------------------------------------------
    // 1. DYNAMIC HEADER RENDERING (Login/Cart)
    // ----------------------------------------------------------------

    // ฟังก์ชันที่สร้างปุ่ม/ลิงก์สำหรับ Header
    function updateHeaderAndWelcome() {
        const username = sessionStorage.getItem('username');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        const linksContainer = document.getElementById('header-auth-links');
        const welcomeSection = document.getElementById('welcome-section');
        
        linksContainer.innerHTML = ''; // Clear existing links

        if (isLogin && username) {
            // Logged-in state
            linksContainer.innerHTML = `
                <a href="cart.html" class="nav-link cart-link">
                    Cart (<span id="cart-count">0</span>)
                </a>
                <a href="profile.html" class="nav-link profile-link">${username}</a>
            `;
            welcomeSection.innerHTML = `
                <h1>Welcome, ${username}!</h1>
                <p>Ready to find something great?</p>
            `;
            fetchCartCount();

        } else {
            // Logged-out state
            linksContainer.innerHTML = `
                <a href="login.html" class="nav-link">Login</a>
                <a href="register.html" class="nav-link">Register</a>
            `;
            welcomeSection.innerHTML = `
                <h1>Welcome</h1>
                <p>Please log in to start shopping.</p>
            `;
        }
    }

    // ฟังก์ชันสำหรับเรียกจำนวนสินค้าในตะกร้า (Mocking the API)
    async function fetchCartCount() {
        const cartCountElement = document.getElementById('cart-count');
        if (!cartCountElement) return;

        // --- Mock Logic ---
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        if (!isLogin) {
            cartCountElement.textContent = '0';
            return;
        }

        // ใช้ mockCartCount ที่เก็บใน SessionStorage เป็นตัวแทน
        const mockCount = sessionStorage.getItem('mockCartCount');
        cartCountElement.textContent = mockCount ? mockCount : '0';
        // --- End Mock Logic ---
        
        // ** ถ้าใช้ API จริง (เมื่อทำเสร็จ) จะใช้โค้ดด้านล่างนี้ **
        /*
        try {
            const userToken = '...'; // ต้องมี Token จริง
            const response = await fetch(GET_CART_COUNT_API, {
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            const data = await response.json();
            cartCountElement.textContent = data.count || '0';
        } catch (error) {
            console.error('Failed to fetch cart count:', error);
            cartCountElement.textContent = 'N/A';
        }
        */
    }

    // ----------------------------------------------------------------
    // 2. PRODUCT GRID RENDERING
    // ----------------------------------------------------------------

    // ฟังก์ชันที่สร้าง HTML ของ Product Card
    function createProductCard(product) {
        return `
            <a href="product-detail.html?id=${product.id}" class="product-card">
                <div class="product-image" style="background-image: url('${product.imageUrl}');"></div>
                <div class="product-info-grid">
                    <div class="product-text-details">
                        <p class="product-name">${product.name}</p>
                        <p class="product-price">${product.price.toFixed(2)} ฿</p>
                        <p class="product-stock">in stock: x${product.stockQuantity}</p>
                    </div>
                    <button type="button" class="add-to-cart-btn" data-product-id="${product.id}" ${product.stockQuantity <= 0 ? 'disabled' : ''}>
                        Add to Cart
                    </button>
                </div>
            </a>
        `;
    }

    // ฟังก์ชันเรียกสินค้าจาก API และแสดงผล (ใช้ API จริง)
    async function fetchAndDisplayProducts() {
        const productsGrid = document.getElementById('products-grid');
        productsGrid.innerHTML = '<p style="text-align: center;">Loading products...</p>';

        try {
            // *** ใช้ API_PRODUCT_ENDPOINT จริง: http://localhost:8080/api/products ***
            const response = await fetch(API_PRODUCT_ENDPOINT); 
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const products = await response.json();

            productsGrid.innerHTML = ''; // Clear loading message

            if (products && products.length > 0) {
                products.forEach(product => {
                    productsGrid.innerHTML += createProductCard(product);
                });
                // หลังจากแสดงสินค้าแล้ว ค่อยตั้งค่า Event Listener
                setupAddToCartHandlers();
            } else {
                productsGrid.innerHTML = '<p style="text-align: center;">No products found.</p>';
            }

        } catch (error) {
            console.error('Error fetching products:', error);
            productsGrid.innerHTML = '<p style="color: red; text-align: center;">Failed to load products from API. (Please check your Spring Boot server and MySQL connection).</p>';
        }
    }


    // ----------------------------------------------------------------
    // 3. ADD TO CART LOGIC
    // ----------------------------------------------------------------

    // ฟังก์ชันหลักในการเพิ่มสินค้าลงตะกร้า (ใช้ Mock URL/Logic)
    async function handleAddToCart(buttonElement) {
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        if (!isLogin) {
            alert('Please log in to add items to the cart.');
            window.location.href = LOGIN_PAGE;
            return;
        }

        const productId = buttonElement.getAttribute('data-product-id');
        
        // Mock API Call: สมมติว่าสำเร็จเสมอ
        try {
            // ใช้ Mock Endpoint สำหรับ Add to Cart 
            const response = await fetch(ADD_TO_CART_MOCK_ENDPOINT); 
            const data = await response.json();
            
            if (data.success) {
                alert(`Product added to cart successfully! (Product ID: ${productId})`); 
                
                // Update Mock Cart Count 
                let currentCartCount = parseInt(sessionStorage.getItem('mockCartCount') || '0');
                currentCartCount += QUANTITY; 
                sessionStorage.setItem('mockCartCount', currentCartCount.toString()); 
                
                // Update Header Display ทันที
                fetchCartCount(); 

            } else {
                alert(data.message || "An unknown error occurred during add to cart."); 
            }

        } catch (error) {
            alert('Server/Mock connection error. Cannot add item to cart.');
        }
    }

    // Sets up click listeners using Event Delegation 
    function setupAddToCartHandlers() {
        const productsGrid = document.getElementById('products-grid');

        if (productsGrid) {
            productsGrid.addEventListener('click', (e) => {
                // ตรวจสอบว่าคลิกที่ปุ่ม Add to Cart 
                if (e.target.classList.contains('add-to-cart-btn')) {
                    // หยุดการทำงานของ <a> tag ที่ครอบอยู่
                    e.stopPropagation(); 
                    // หยุดการนำทางของ <a> tag ที่ครอบอยู่
                    e.preventDefault();
                    // ส่ง Element ของปุ่มไป
                    handleAddToCart(e.target); 
                }
            });
        }
    }


    // ----------------------------------------------------------------
    // 4. INITIALIZATION
    // ----------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderAndWelcome();
        fetchAndDisplayProducts(); 
    });
</script>
</body>
</html>