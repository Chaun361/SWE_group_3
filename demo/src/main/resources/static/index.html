<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
        <section class="welcome-section" id="welcome-section">
            <h1>Welcome</h1>
            </section>

        <section class="products-grid" id="products-grid">
            <p style="text-align: center; padding: 20px;">Loading products...</p>
        </section>

    </main>
<script>
    // API Endpoint ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
    const ADD_TO_CART_MOCK_ENDPOINT = '/mock/add_to_cart.json'; 
    const ADD_TO_CART_API = '/api/cart/items'; 
    const API_PRODUCT_ENDPOINT = '/mock/products.json'; // ‡πÉ‡∏ä‡πâ Mock JSON file
    const QUANTITY = 1; 
    const LOGIN_PAGE = 'login.html';

    // Global variable to mock the cart count (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Cart Count ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    let currentCartCount = 0; 

    // ----------------------------------------------------------------
    // 1. HEADER & WELCOME SECTION LOGIC (Task 3/5)
    // ----------------------------------------------------------------

    function updateHeaderAndWelcome() {
        const username = sessionStorage.getItem('username'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        const linksContainer = document.getElementById('header-auth-links');
        const welcomeSection = document.getElementById('welcome-section');

        linksContainer.innerHTML = ''; 

        if (isLogin) {
            // Login ‡πÅ‡∏•‡πâ‡∏ß: ‡πÅ‡∏™‡∏î‡∏á order history, {username}, ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏£‡πâ‡∏≠‡∏° Cart Count)
            linksContainer.innerHTML = `
                <a href="order-history.html" class="nav-link">Order History</a>
                <a href="profile.html" class="nav-link">${username}</a>
                <a href="cart.html" class="nav-link cart-icon">üõí (<span id="cart-count">0</span>)</a> 
            `;
            // Update Welcome Message
            welcomeSection.innerHTML = `
                <h1>Welcome back, ${username}!</h1>
                <p>Start browsing our latest products.</p>
            `;
             // ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà Header ‡∏ñ‡∏π‡∏Å Render
            fetchCartCount(); 
        } else {
            // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login: ‡πÅ‡∏™‡∏î‡∏á Login, Register
            linksContainer.innerHTML = `
                <a href="${LOGIN_PAGE}" class="nav-link">Login</a>
                <a href="register.html" class="nav-link">Register</a>
            `;
            // Update Welcome Message
            welcomeSection.innerHTML = `
                <h1>Welcome</h1>
                <p>Please log in to start shopping.</p>
            `;
        }
    }

    // ----------------------------------------------------------------
    // 2. PRODUCT DISPLAY LOGIC (Task 4 - Revised for new JSON structure)
    // ----------------------------------------------------------------
    
    function renderProducts(products) {
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = ''; 

        products.forEach(product => {
            // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà: productId, productName, stockQuantity
            const cardHtml = `
                <div class="product-card" onclick="window.location.href='product-detail.html?id=${product.productId}'">
                    <div class="product-image">
                        <img src="${product.imageUrl || 'placeholder.png'}" alt="${product.productName}" style="width: 100%; height: auto;">
                    </div>
                    <div class="product-info-grid">
                        <div class="product-text-details">
                            <p class="product-name">${product.productName}</p>
                            <p class="product-price">‡∏ø ${product.price.toLocaleString()}</p>
                            <p class="product-stock">in stock: x${product.stockQuantity || '?'}</p> 
                        </div>
                        <button class="add-to-cart-btn" data-product-id="${product.productId}">Add</button>
                    </div>
                </div>
            `;
            gridElement.innerHTML += cardHtml;
        });
    }

    async function fetchAndDisplayProducts() {
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = '<p style="text-align: center; padding: 20px;">Fetching product data...</p>';

        // Hardcoded Fallback Data (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà fetch ‡πÑ‡∏ü‡∏•‡πå Mock ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
        const FALLBACK_PRODUCTS = [
             { "productId": 1, "productName": "Wireless Mouse", "price": 450.0, "stockQuantity": 30, "imageUrl": "mock-mouse.jpg" },
             { "productId": 2, "productName": "Mechanical Keyboard", "price": 1250.0, "stockQuantity": 20, "imageUrl": "mock-keyboard.jpg" },
             { "productId": 4, "productName": "Gaming Headset", "price": 990.0, "stockQuantity": 25, "imageUrl": "mock-headset.jpg" },
             { "productId": 5, "productName": "USB-C Charger 65W", "price": 799.0, "stockQuantity": 40, "imageUrl": "mock-charger.jpg" },
        ];

        try {
            // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ fetch ‡∏à‡∏≤‡∏Å Mock JSON file
            const response = await fetch(API_PRODUCT_ENDPOINT); 
            
            if (!response.ok) {
                throw new Error(`Failed to fetch products: ${response.status}`);
            }

            const products = await response.json(); 
            renderProducts(products); 
            
        } catch (error) {
            console.error('Error loading products from file. Using hardcoded fallback.', error);
            
            // ‡πÉ‡∏ä‡πâ Hardcoded Fallback Data
            gridElement.innerHTML = '<p style="color: orange; padding: 10px;">Could not fetch product file. Displaying fallback data.</p>';
            renderProducts(FALLBACK_PRODUCTS); 

        }
    }

    // ----------------------------------------------------------------
    // 3. CART COUNT LOGIC (Task 2)
    // ----------------------------------------------------------------
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (Mock Logic)
    async function fetchCartCount() {
        const userId = sessionStorage.getItem('userId');
        const countElement = document.getElementById('cart-count');
        
        if (!userId || !countElement) return;

        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å currentCartCount ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢ Add to Cart
        const count = currentCartCount; 
        
        countElement.textContent = count.toString(); 
    }

    // ----------------------------------------------------------------
    // 4. ADD TO CART LOGIC (Task 1)
    // ----------------------------------------------------------------

    async function handleAddToCart(e) {
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login
        if (!isLogin || !userId) {
            alert('Please log in to add items to your cart.');
            return;
        }

        const button = e.target;
        const productId = button.getAttribute('data-product-id');

        if (!productId) return;

        const requestBody = {
            userId: userId,
            productId: parseInt(productId), 
            quantity: QUANTITY
        }; 

        try {
            // ‡πÉ‡∏ä‡πâ Mock Logic ‡πÅ‡∏ó‡∏ô Fetch ‡∏à‡∏£‡∏¥‡∏á 
            const response = await fetch(ADD_TO_CART_MOCK_ENDPOINT);
            const data = await response.json();
            
            // --- Mock Logic: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç Success/Error ---
            
            // Mock Error Scenario (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤ productId ‡πÄ‡∏õ‡πá‡∏ô 9 ‡∏à‡∏∞ Out of Stock)
            if (productId === '9') { 
                alert("Product not found / Out of stock"); 
                return;
            }
            
            if (data.success) {
                alert(`Product added to cart successfully! (Product ID: ${productId})`); 
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Cart Count ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                currentCartCount += QUANTITY; 
                fetchCartCount(); 

            } else {
                alert(data.message || "An unknown error occurred during add to cart."); 
            }

        } catch (error) {
            console.error('Add to Cart Error:', error);
            alert('Server/Mock connection error. Cannot add item to cart.');
        }
    }

    // Sets up click listeners using Event Delegation 
    function setupAddToCartHandlers() {
        const productsGrid = document.getElementById('products-grid');

        if (productsGrid) {
            productsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    e.stopPropagation(); 
                    handleAddToCart(e);
                }
            });
        }
    }
    
    // ----------------------------------------------------------------
    // 5. INITIALIZATION
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderAndWelcome();
        fetchAndDisplayProducts(); 
        setupAddToCartHandlers(); 
    });
</script>
</body>
</html>