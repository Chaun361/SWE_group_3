<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
    
    <section class="welcome-section" id="welcome-section">
        <h1>Welcome</h1>
        </section>

    <h2 class="products-title">Products</h2> 
    
    <section class="products-grid" id="products-grid">
        </section>
        <div class="product-info-grid">

    </main>
<script>
    // API Endpoint ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
    const ADD_TO_CART_MOCK_ENDPOINT = '/mock/add_to_cart.json'; 
    const ADD_TO_CART_API = 'http://localhost:8080/api/cart/add'; // Updated API endpoint
    const API_PRODUCT_ENDPOINT = 'http://localhost:8080/api/products'; 
    const QUANTITY = 1; 
    const LOGIN_PAGE = 'login.html';

    // Global variable to mock the cart count
    let currentCartCount = 0; 

    // Hardcoded Fallback Data (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
    const FALLBACK_PRODUCTS = [
        // **‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà renderProducts ‡πÉ‡∏ä‡πâ**
        { productId: 1, productName: 'Wireless Mouse', price: 450.0, stockQuantity: 30, imageUrl: '1.jpg' }, 
        { productId: 2, productName: 'Mechanical Keyboard', price: 1250.0, stockQuantity: 20, imageUrl: '2.jpg' },
        { productId: 4, productName: 'Gaming Headset', price: 990.0, stockQuantity: 25, imageUrl: '4.jpg' },
        { productId: 5, productName: 'USB-C Charger 65W', price: 799.0, stockQuantity: 40, imageUrl: '5.jpg' },
        { productId: 6, productName: '27-inch 4K Monitor', price: 8990.0, stockQuantity: 8, imageUrl: '6.jpg' },
        { productId: 7, productName: 'Laptop Stand Adjustable', price: 650.0, stockQuantity: 18, imageUrl: '7.jpg' },
        { productId: 8, productName: 'External SSD 1TB', price: 3290.0, stockQuantity: 12, imageUrl: '8.jpg' },
        { productId: 9, productName: 'Bluetooth Speaker', price: 1150.0, stockQuantity: 22, imageUrl: '9.jpg' },
    ];
    const IMAGE_MAP = {
    // ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà Backend ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å product.id ‡πÉ‡∏ô JSON)
    "1": "1.jpg", 
    "2": "2.jpg", 
    "4": "4.jpg", 
    "5": "5.jpg", // PlayStation 5
    "6": "6.jpg", // Monitor/iPad Pro
    "7": "7.jpg", 
    "8": "8.jpg",
    "9": "9.jpg"
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
};

    // ----------------------------------------------------------------
    // 1. DYNAMIC HEADER RENDERING (Unchanged)
    // ----------------------------------------------------------------
    function updateHeaderAndWelcome() {
        const username = sessionStorage.getItem('username');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        const linksContainer = document.getElementById('header-auth-links');
        const welcomeSection = document.getElementById('welcome-section');
        
        linksContainer.innerHTML = ''; 

        if (isLogin) {
            const mockCartCount = sessionStorage.getItem('mockCartCount') || '0';
            currentCartCount = parseInt(mockCartCount);
            
            linksContainer.innerHTML = `
                <a href="index.html" class="nav-link">HOME</a>
                <a href="order-history.html" class="nav-link">order history</a>
                <a href="profile.html" class="nav-link">${username} üë§</a>
                <a href="cart.html" class="nav-link cart-icon">üõí (<span id="cart-count">${mockCartCount}</span>)</a> 
            `;
            welcomeSection.innerHTML = `<h1>Welcome</h1><p>description</p>`;
        } else {
            linksContainer.innerHTML = `
                <a href="${LOGIN_PAGE}" class="nav-link">Login</a>
                <a href="register.html" class="nav-link">Register</a>
            `;
            welcomeSection.innerHTML = `<h1>Welcome</h1><p>description</p>`;
        }
    }


    // ----------------------------------------------------------------
    // 2. PRODUCT FETCHING & RENDERING LOGIC (Unchanged)
    // ----------------------------------------------------------------

    function renderProducts(products) {
    const gridElement = document.getElementById('products-grid');
    gridElement.innerHTML = ''; 

        products.forEach(product => {
            // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà: productId, productName, stockQuantity
            const cardHtml = `
        <div class="product-card" onclick="window.location.href='product-detail.html?id=${product.id}'">
        <div class="product-image">
            <img src="images/${product.id}.jpg" alt="${product.productName}" style="width: 100%; height: auto;">
        </div>
        </div>
                    <div class="product-info-grid">
                        <div class="product-text-details">
                            <p class="product-name">${product.productName}</p>
                            <p class="product-price">‡∏ø ${product.price.toLocaleString()}</p>
                            <p class="product-stock">in stock: x${product.stockQuantity || '?'}</p> 
                        </div>
                        <button class="add-to-cart-btn" data-product-id="${product.id}">Add</button>
                    </div>
                </div>
            `;
            gridElement.innerHTML += cardHtml;
        });
    }

    async function fetchAndDisplayProducts() {
        // ... (Logic fetch ‡πÅ‡∏•‡∏∞ Fallback ‡πÄ‡∏î‡∏¥‡∏°) ...
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = '<p style="text-align: center; padding: 20px;">Fetching product data from API...</p>';

        try {
            const response = await fetch(API_PRODUCT_ENDPOINT);
            let products = [];
            
            if (response.ok) { products = await response.json(); } 
            else if (response.status === 204) { products = []; } 
            else { throw new Error(`API Error: ${response.status}`); }

            if (products.length === 0) {
                gridElement.innerHTML = '<p style="text-align: center; padding: 20px;">No products found on the server.</p>';
            } else {
                renderProducts(products); 
            }

        } catch (error) {
            console.error('Product Fetch Error:', error);
            gridElement.innerHTML = `<p style="color: red; text-align: center; padding: 10px;">API Connection Failed. Displaying fallback products. Error: ${error.message || error}</p>`;
            renderProducts(FALLBACK_PRODUCTS); 
        }
    }
    
    // ----------------------------------------------------------------
    // 3. CART STORE & ADD TO CART LOGIC (MODIFIED)
    // ----------------------------------------------------------------

    async function fetchCartCount() {
        const countElement = document.getElementById('cart-count');
        if (!countElement) return;
        countElement.textContent = currentCartCount.toString(); 
    }
    
    // *******************************************************
    // * NEW HELPER: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Local Cart Store (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) *
    // *******************************************************
    function updateLocalCart(productIdStr, quantity) {
        const cartKey = 'localCartItems';
        let cart = JSON.parse(sessionStorage.getItem(cartKey) || '[]'); 
        const productId = parseInt(productIdStr);

        // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å Fallback List (‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Render)
        const productDetails = FALLBACK_PRODUCTS.find(p => p.productId === productId);
        
        if (!productDetails) {
            console.error(`Product ID ${productId} not found for local storage!`);
            return;
        }

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const itemIndex = cart.findIndex(item => item.productId === productId);
        
        if (itemIndex > -1) {
            // ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            cart[itemIndex].quantity += quantity;
            cart[itemIndex].subtotal = cart[itemIndex].price * cart[itemIndex].quantity; 
        } else {
            // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            cart.push({
                productId: productId,
                name: productDetails.productName,
                price: productDetails.price,
                quantity: quantity,
                subtotal: productDetails.price * quantity
            });
        }

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà sessionStorage
        sessionStorage.setItem(cartKey, JSON.stringify(cart));
    }


    async function handleAddToCart(button) { 
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        if (!isLogin || !userId) {
            alert('Please log in to add items to your cart.');
            window.location.href = LOGIN_PAGE;
            return;
        }

        const productId = button.getAttribute('data-product-id');
        if (!productId) return;

        // MODIFIED: Use the actual API endpoint with POST method
        try {
            // Create the URL with query parameters
            const url = `${ADD_TO_CART_API}?userId=${userId}&productId=${productId}&quantity=${QUANTITY}`;
            
            // Make the POST request
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            // Check if the request was successful
            if (response.ok) {
                const data = await response.json();
                
                // Check if the API response indicates success
                if (data && data.items) {
                    alert(`Product added to cart successfully! (Product ID: ${productId})`); 
                    
                    // * FIXED: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Local Cart Store ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *
                    updateLocalCart(productId, QUANTITY); 
                    
                    // Update Cart Count based on API response
                    // Calculate total items in cart from the API response
                    const totalItems = data.items.reduce((total, item) => total + item.quantity, 0);
                    sessionStorage.setItem('mockCartCount', totalItems.toString()); 
                    
                    fetchCartCount(); 
                } else {
                    alert("Failed to add item to cart. Please try again.");
                }
            } else {
                // Handle HTTP error status
                const errorText = await response.text();
                console.error('API Error:', response.status, errorText);
                alert(`Failed to add item to cart. Server returned ${response.status}.`);
            }

        } catch (error) {
            console.error('Add to Cart Error:', error);
            alert('Server connection error. Cannot add item to cart.');
        }
    }

    function setupAddToCartHandlers() {
        const productsGrid = document.getElementById('products-grid');

        if (productsGrid) {
            productsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    e.stopPropagation(); 
                    e.preventDefault(); 
                    handleAddToCart(e.target); 
                }
            });
        }
    }


    // ----------------------------------------------------------------
    // 4. INITIALIZATION
    // ----------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderAndWelcome();
        fetchAndDisplayProducts();
        setupAddToCartHandlers(); // Add event handlers for Add to Cart buttons
    });
</script>
</body>
</html>