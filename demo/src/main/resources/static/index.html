<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
        <section class="welcome-section" id="welcome-section">
            <h1>Welcome</h1>
            </section>

        <section class="products-grid" id="products-grid">
            <p style="text-align: center; padding: 20px;">Loading products...</p>
        </section>

    </main>
    <script>
    // API Endpoint และค่าคงที่
    const ADD_TO_CART_MOCK_ENDPOINT = '/mock/add_to_cart.json'; 
    const ADD_TO_CART_API = '/api/cart/items'; 
    const API_PRODUCT_ENDPOINT = '/mock/products.json'; // ใช้ Mock JSON file
    const QUANTITY = 1; 
    
    // ... (ฟังก์ชัน updateHeaderAndWelcome ยังคงเหมือนเดิม) ...

    // ----------------------------------------------------------------
    // 2. PRODUCT DISPLAY LOGIC (Revised for new JSON structure)
    // ----------------------------------------------------------------
    
    function renderProducts(products) {
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = ''; 

        products.forEach(product => {
            // ใช้ชื่อฟิลด์ใหม่: productId, productName, stockQuantity
            const cardHtml = `
                <div class="product-card" onclick="window.location.href='product-detail.html?id=${product.productId}'">
                    <div class="product-image">
                        <img src="${product.imageUrl || 'placeholder.png'}" alt="${product.productName}" style="width: 100%; height: auto;">
                    </div>
                    <div class="product-info-grid">
                        <div class="product-text-details">
                            <p class="product-name">${product.productName}</p>
                            <p class="product-price">฿ ${product.price.toLocaleString()}</p>
                            <p class="product-stock">in stock: x${product.stockQuantity || '?'}</p> 
                        </div>
                        <button class="add-to-cart-btn" data-product-id="${product.productId}">Add</button>
                    </div>
                </div>
            `;
            gridElement.innerHTML += cardHtml;
        });
    }

    async function fetchAndDisplayProducts() {
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = '<p style="text-align: center; padding: 20px;">Fetching product data...</p>';

        try {
            const response = await fetch(API_PRODUCT_ENDPOINT); 
            
            if (!response.ok) {
                throw new Error(`Failed to fetch products: ${response.status}`);
            }

            // เนื่องจาก Mock JSON ตอนนี้ใช้ชื่อฟิลด์ใหม่แล้ว เราจึงต้องอัปเดตฟังก์ชัน render
            const products = await response.json(); 
            renderProducts(products); 

        } catch (error) {
            console.error('Error loading products:', error);
            gridElement.innerHTML = '<p style="color: red; padding: 20px;">Could not load products. Using Mock JSON failed.</p>';
        }
    }


    // ----------------------------------------------------------------
    // 3. ADD TO CART LOGIC (Revised for new JSON structure in request body)
    // ----------------------------------------------------------------

    async function handleAddToCart(e) {
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        // 1. ตรวจสอบสถานะ Login
        if (!isLogin || !userId) {
            alert('Please log in to add items to your cart.');
            return;
        }

        const button = e.target;
        const productId = button.getAttribute('data-product-id');

        if (!productId) return;

        const requestBody = {
            // ใช้ productId ตามโครงสร้างใหม่
            userId: userId,
            productId: parseInt(productId), // ส่งเป็นตัวเลขตาม API
            quantity: QUANTITY
        }; 

        try {
            // ใช้ Mock Logic แทน Fetch จริง (GET MOCK_ENDPOINT) 
            const response = await fetch(ADD_TO_CART_MOCK_ENDPOINT);
            const data = await response.json();
            
            // --- Mock Logic: จำลองเงื่อนไข Success/Error ---
            
            // Mock Error Scenario (สมมติว่าถ้า productId เป็น 9 จะ Out of Stock)
            if (productId === '9') { 
                alert("Product not found / Out of stock"); 
                return;
            }
            
            if (data.success) {
                alert(`Product added to cart successfully! (Product ID: ${productId})`); 
            } else {
                alert(data.message || "An unknown error occurred during add to cart."); 
            }

        } catch (error) {
            console.error('Add to Cart Error:', error);
            alert('Server/Mock connection error. Cannot add item to cart.');
        }
    }

    // Sets up click listeners using Event Delegation 
    function setupAddToCartHandlers() {
        const productsGrid = document.getElementById('products-grid');

        if (productsGrid) {
            productsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    e.stopPropagation(); 
                    handleAddToCart(e);
                }
            });
        }
    }
    
    // ----------------------------------------------------------------
    // 4. INITIALIZATION
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderAndWelcome();
        fetchAndDisplayProducts(); 
        setupAddToCartHandlers(); 
    });
</script>
</body>
</html>