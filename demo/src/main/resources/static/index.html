<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <a href="index.html" class="index">home</a>
        <nav class="auth-links" id="header-auth-links">
        </nav>
    </header>

    <main class="container">
    
        <section class="welcome-section" id="welcome-section">
            <h1>Welcome</h1>
            <p>description</p>
        </section>

        <h2 class="products-title">Products</h2> 
        
        <section class="products-grid" id="products-grid">
            <p style="text-align: center; padding: 20px; grid-column: 1 / -1;">Loading products...</p>
        </section>

    </main>

<script>
    // API Endpoint ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
    const ADD_TO_CART_API = 'http://localhost:8080/api/cart/add';
    const API_PRODUCT_ENDPOINT = 'http://localhost:8080/api/products'; 
    const QUANTITY = 1; 
    const LOGIN_PAGE = 'login.html';

    let currentCartCount = 0; 

    const FALLBACK_PRODUCTS = [
        { productId: 1, productName: 'Wireless Mouse', price: 450.0, stockQuantity: 30, imageUrl: '1.jpg' }, 
        { productId: 2, productName: 'Mechanical Keyboard', price: 1250.0, stockQuantity: 20, imageUrl: '2.jpg' },
        { productId: 4, productName: 'Gaming Headset', price: 990.0, stockQuantity: 25, imageUrl: '4.jpg' },
        { productId: 5, productName: 'USB-C Charger 65W', price: 799.0, stockQuantity: 40, imageUrl: '5.jpg' },
        { productId: 6, productName: '27-inch 4K Monitor', price: 8990.0, stockQuantity: 8, imageUrl: '6.jpg' },
        { productId: 7, productName: 'Laptop Stand Adjustable', price: 650.0, stockQuantity: 18, imageUrl: '7.jpg' },
        { productId: 8, productName: 'External SSD 1TB', price: 3290.0, stockQuantity: 12, imageUrl: '8.jpg' },
        { productId: 9, productName: 'Bluetooth Speaker', price: 1150.0, stockQuantity: 22, imageUrl: '9.jpg' },
    ];

    const IMAGE_MAP = {
        "1": "1.jpg", 
        "2": "2.jpg", 
        "4": "4.jpg", 
        "5": "5.jpg",
        "6": "6.jpg",
        "7": "7.jpg", 
        "8": "8.jpg",
        "9": "9.jpg"
    };

    function updateHeaderAndWelcome() {
        const username = sessionStorage.getItem('username');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';
        const linksContainer = document.getElementById('header-auth-links');
        const welcomeSection = document.getElementById('welcome-section');
        
        linksContainer.innerHTML = ''; 

        if (isLogin) {
            const mockCartCount = sessionStorage.getItem('mockCartCount') || '0';
            currentCartCount = parseInt(mockCartCount);
            
            linksContainer.innerHTML = `
                <a href="order-history.html" class="nav-link">order history</a>
                <a href="profile.html" class="nav-link">${username} üë§</a>
                <a href="cart.html" class="nav-link cart-icon">üõí (<span id="cart-count">${mockCartCount}</span>)</a> 
            `;
            welcomeSection.innerHTML = `<h1>Welcome</h1><p>description</p>`;
        } else {
            linksContainer.innerHTML = `
                <a href="${LOGIN_PAGE}" class="nav-link">login üë§</a>
            `;
            welcomeSection.innerHTML = `<h1>Welcome</h1><p>Please login to start shopping</p>`;
        }
    }

    function renderProducts(products) {
    const gridElement = document.getElementById('products-grid');
    gridElement.innerHTML = ''; 

        products.forEach(product => {
            // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà: productId, productName, stockQuantity
            const cardHtml = `
                <div class="product-card">
                    <div class="product-image" onclick="window.location.href='product-detail.html?id=${product.id}'">
                        <img src="images/${product.id}.jpg" alt="${product.productName}" style="width: 100%; height: auto;">
                    </div>
                    <div class="product-info-grid">
                        <div class="product-text-details">
                            <p class="product-name">${product.productName}</p>
                            <p class="product-price">‡∏ø ${product.price.toLocaleString()}</p>
                            <p class="product-stock">in stock: x${product.stockQuantity || '?'}</p> 
                        </div>
                        <button class="add-to-cart-btn" data-product-id="${product.id}">Add</button>
                    </div>
                </div>
            `;
            gridElement.innerHTML += cardHtml;
        });
    }
    

    async function fetchAndDisplayProducts() {
        const gridElement = document.getElementById('products-grid');
        gridElement.innerHTML = '<p style="text-align: center; padding: 20px; grid-column: 1 / -1;">Fetching product data from API...</p>';

        try {
            const response = await fetch(API_PRODUCT_ENDPOINT);
            let products = [];
            
            if (response.ok) { 
                products = await response.json(); 
            } else if (response.status === 204) { 
                products = []; 
            } else { 
                throw new Error(`API Error: ${response.status}`); 
            }

            if (products.length === 0) {
                gridElement.innerHTML = '<p style="text-align: center; padding: 20px; grid-column: 1 / -1;">No products found on the server.</p>';
            } else {
                renderProducts(products); 
            }

        } catch (error) {
            console.error('Product Fetch Error:', error);
            gridElement.innerHTML = `<p style="color: red; text-align: center; padding: 10px; grid-column: 1 / -1;">API Connection Failed. Displaying fallback products.</p>`;
            renderProducts(FALLBACK_PRODUCTS); 
        }
    }

   function fetchCartCount() {
        const countElement = document.getElementById('cart-count');
        if (!countElement) return;
        countElement.textContent = currentCartCount.toString(); 
    }

    function updateLocalCart(productIdStr, quantity) {
        const cartKey = 'localCartItems';
        let cart = JSON.parse(sessionStorage.getItem(cartKey) || '[]'); 
        const productId = parseInt(productIdStr);

        const productDetails = FALLBACK_PRODUCTS.find(p => p.productId === parseInt(productId));
        const productName = productDetails ? productDetails.productName : `Product ${productId}`;
        
        if (!productDetails) {
            console.error(`Product ID ${productId} not found for local storage!`);
            return;
        }

        const itemIndex = cart.findIndex(item => item.productId === productId);
        
        if (itemIndex > -1) {
            cart[itemIndex].quantity += quantity;
            cart[itemIndex].subtotal = cart[itemIndex].price * cart[itemIndex].quantity; 
        } else {
            cart.push({
                productId: productId,
                name: productDetails.productName,
                price: productDetails.price,
                quantity: quantity,
                subtotal: productDetails.price * quantity
            });
        }

        sessionStorage.setItem(cartKey, JSON.stringify(cart));
    }

    async function handleAddToCart(button) { 
        const userId = sessionStorage.getItem('userId');
        const isLogin = sessionStorage.getItem('isLogin') === 'true';

        if (!isLogin || !userId) {
            alert('Please log in to add items to your cart.');
            window.location.href = LOGIN_PAGE;
            return;
        }

        const productId = button.getAttribute('data-product-id');
        if (!productId) return;

        // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å product card ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏°‡∏≤‡∏à‡∏≤‡∏Å backend)
        const productCard = button.closest('.product-card');
        const productNameElement = productCard.querySelector('.product-name');
        const productName = productNameElement ? productNameElement.textContent : `Product ${productId}`;

        // MODIFIED: Use the actual API endpoint with POST method
        try {
            // Create the URL with query parameters
            const url = `${ADD_TO_CART_API}?userId=${userId}&productId=${productId}&quantity=${QUANTITY}`;
            
            // Make the POST request
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            // Check if the request was successful
            if (response.ok) {
                const data = await response.json();
                
                // Check if the API response indicates success
                if (data && data.items) {
                    alert(`Added ${productName} to the cart!`); 
                    
                    // * FIXED: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Local Cart Store ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *
                    updateLocalCart(productId, QUANTITY); 
                    
                    // Update Cart Count based on API response
                    // Calculate total items in cart from the API response
                    const totalItems = data.items.reduce((total, item) => total + item.quantity, 0);
                    sessionStorage.setItem('mockCartCount', totalItems.toString()); 
                    
                    fetchCartCount(); 
                } else {
                    alert("Failed to add item to cart. Please try again.");
                }
            } else if (response.status === 400) {
                // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å
                alert(`${productName} out of stock!`);
            } else {
                // Handle other HTTP error status
                const errorText = await response.text();
                console.error('API Error:', response.status, errorText);
                alert(`Failed to add item to cart. Server returned ${response.status}.`);
            }

        } catch (error) {
            console.error('Add to Cart Error:', error);
            alert('Server connection error. Cannot add item to cart.');
        }
    }


    function setupAddToCartHandlers() {
        const productsGrid = document.getElementById('products-grid');

        if (productsGrid) {
            productsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    e.stopPropagation(); 
                    e.preventDefault(); 
                    handleAddToCart(e.target); 
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderAndWelcome();
        fetchAndDisplayProducts();
        setupAddToCartHandlers();
    });
</script>
</body>
</html>