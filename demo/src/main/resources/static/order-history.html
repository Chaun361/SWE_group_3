<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order History</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="order-history.css">
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <div class="nav-left">
        <h2 class="logo">WEBSITE NAME</h2>
        <a href="index.html" class="nav-item">home</a>
    </div>

    <div class="nav-right">
        <a href="order-history.html" class="nav-item">order history</a>
        <a href="profile.html" id="username-link" class="nav-item"><span id="username-display"></span> üë§</a>
        <a href="cart.html" class=" nav-item cart-icon">üõí <span id="cart-count">(0)</span></a>
    </div>
  </header>

  <main class="order-container">
    <h1 class="page-title">Order history</h1>
    <div id="order-list" class="order-list">Loading...</div>
  </main>

  <!-- JS -->
  <script>  

  document.addEventListener("DOMContentLoaded", () => {
  // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å sessionStorage
  const username = sessionStorage.getItem("username") || "guest";
  document.getElementById("username-display").textContent = username;

  // mock cart count ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å backend
  const cart = sessionStorage.getItem("mockCartCount") || 0;
  document.getElementById("cart-count").textContent = `(${cart})`;
  });

  document.addEventListener("DOMContentLoaded", loadOrderHistory);

  const userId = sessionStorage.getItem("userId") || 1;

  // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  function formatDate(dateString) {
    const d = new Date(dateString);
    return d.toLocaleDateString("en-CA");
  }

  // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
  function formatTime(dateString) {
    const d = new Date(dateString);
    return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  // ‡∏Ñ‡∏∑‡∏ô class ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  function getStatusClass(status) {
    const s = status.toLowerCase();

    if (s === "pending") return "status-badge status-pending";
    if (s === "completed") return "status-badge status-completed";
    if (s === "cancelled") return "status-badge status-cancelled";

    return "status-badge";
  }

  // ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á Placed ‚Üí Pending ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
  function normalizeStatus(status) {
    if (!status) return "Pending";
    const s = status.toLowerCase();

    if (s === "placed") return "Pending";   // <--- ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    return status;
  }

  async function loadOrderHistory() {
    const container = document.getElementById("order-list");
    container.innerHTML = "Loading...";

    try {
      const response = await fetch(`/api/orders/history/${userId}`);
      const orders = await response.json();

      if (!Array.isArray(orders) || orders.length === 0) {
        container.innerHTML = "<p>No orders found.</p>";
        return;
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏™‡∏∏‡∏î
      const sortedOrders = orders.sort(
        (a, b) => new Date(b.orderDate) - new Date(a.orderDate)
      );

      container.innerHTML = sortedOrders
        .map((order, index) => {

          // ‚≠ê convert Placed ‚Üí Pending
          const displayStatus = normalizeStatus(order.status);

          const statusClass = getStatusClass(displayStatus);

          const date = formatDate(order.orderDate);
          const time = formatTime(order.orderDate);
          const total = order.total.toFixed(2);

          let itemsHTML = order.orderItems
            .map(
              (item) => `
              <div class="item-row">
                <div>
                  ${item.productName}<br>
                  <span style="color:gray; font-size:13px;">
                    ${item.pricePerUnit} Baht √ó ${item.quantity}
                  </span>
                </div>
                <div>${(item.pricePerUnit * item.quantity).toFixed(2)} Baht</div>
              </div>
            `
            )
            .join("");

          return `
            <div class="order-box">
              <div class="order-header">
                <div class="order-header-left">
                    <span class="order-icon">üì¶</span>
                    <div>
                      <div><strong>Order #${index + 1}</strong></div>
                      <div class="order-date">${date} ‚è± ${time}</div>
                    </div>
                </div>

                <span class="${statusClass}">
                  ${displayStatus}
                </span>
              </div>

              <div class="order-items">${itemsHTML}</div>

              <div class="total-row">
                <span>Total</span>
                <span>${total} Baht</span>
              </div>
            </div>
          `;
        })
        .join("");

    } catch (error) {
      console.error("Order history load error:", error);
      container.innerHTML = "<p>Error loading order history.</p>";
    }
  }
  </script>

</body>
</html>
