<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Product Detail | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="product-detail.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
        <div id="product-detail-content">
            <p style="text-align: center; padding: 50px;">Loading product details...</p>
        </div>
    </main>
    
    <script>
        const LOGIN_PAGE = 'login.html';
        const ADD_TO_CART_MOCK_ENDPOINT = 'mock/add_to_cart.json'; 
        const API_PRODUCT_ENDPOINT = 'mock/products.json'; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà
        
        // ----------------------------------------------------------------
        // 1. HEADER & LOGIN CHECK
        // ----------------------------------------------------------------
        function updateHeader() {
            const username = sessionStorage.getItem('username');
            const isLogin = sessionStorage.getItem('isLogin') === 'true';
            const linksContainer = document.getElementById('header-auth-links');
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Cart Count ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Session Storage
            const mockCartCount = sessionStorage.getItem('mockCartCount') || '0'; 

            if (!isLogin || !username) {
                linksContainer.innerHTML = `<a href="${LOGIN_PAGE}" class="nav-link">Login</a><a href="register.html" class="nav-link">Register</a>`;
                return false; 
            }
            
            // Render Logged-in Header
            linksContainer.innerHTML = `
                <a href="index.html" class="nav-link">HOME</a>
                <a href="order-history.html" class="nav-link">order history</a>
                <a href="profile.html" class="nav-link">${username} üë§</a>
                <a href="cart.html" class="nav-link cart-icon">üõí (<span id="cart-count">${mockCartCount}</span>)</a> 
            `;
            return true;
        }

        // ----------------------------------------------------------------
        // 2. RENDER AND FETCH LOGIC
        // ----------------------------------------------------------------
        function getProductIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id'); // ‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å URL ‡πÄ‡∏ä‡πà‡∏ô ?id=1
        }
        
        async function fetchAndRenderProductDetail() {
            const productId = getProductIdFromUrl();
            const container = document.getElementById('product-detail-content');
            
            if (!productId) {
                container.innerHTML = '<p style="color: red; text-align: center; padding: 50px;">Error: Product ID not specified.</p>';
                return;
            }

            try {
                // Mock Fetch: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                const response = await fetch(API_PRODUCT_ENDPOINT); 
                if (!response.ok) throw new Error('Failed to fetch mock products.');

                const allProducts = await response.json(); 
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏° productId
                const product = allProducts.find(p => p.productId.toString() === productId);

                if (!product) {
                    container.innerHTML = `<p style="color: red; text-align: center; padding: 50px;">Error: Product ID ${productId} not found.</p>`;
                    return;
                }
                
                // Render Detail
                renderDetail(product);

            } catch (error) {
                console.error('Detail Load Error:', error);
                container.innerHTML = `<p style="color: red; text-align: center; padding: 50px;">Error loading details: ${error.message}. Check products.json file path.</p>`;
            }
        }
        
        function renderDetail(product) {
            const container = document.getElementById('product-detail-content');
            
            container.innerHTML = `
                <div class="detail-content">
                    <div class="product-image-large">
                        <img src="images/${product.imageUrl || 'placeholder.png'}" alt="${product.productName}">
                    </div>
                    <div class="product-info-detail">
                        <h1>${product.productName}</h1>
                        <p class="product-sku">SKU: PD${product.productId} | Stock: ${product.stockQuantity}</p>
                        
                        <div class="detail-description">
                            <h3>Product Description</h3>
                            <p>This product is a ${product.productName} with ${product.stockQuantity} units remaining. Key specifications include:</p>
                            <ul>
                                <li>Price: ‡∏ø ${product.price.toLocaleString()}</li>
                                <li>High Quality Material (Mock Detail)</li>
                                <li>Easy Installation (Mock Detail)</li>
                            </ul>
                        </div>

                        <div class="detail-actions">
                            <p class="detail-price">‡∏ø ${product.price.toLocaleString()}</p>
                            
                            <div class="quantity-selector">
                                <label for="quantity">Quantity:</label>
                                <input type="number" id="quantity" value="1" min="1" max="${product.stockQuantity}">
                            </div>

                            <button class="add-to-cart-btn large" data-product-id="${product.productId}" id="detail-add-btn">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup Add to Cart Handler for the new button
            document.getElementById('detail-add-btn').addEventListener('click', handleDetailAddToCart);
        }

        // ----------------------------------------------------------------
        // 3. ADD TO CART LOGIC
        // ----------------------------------------------------------------
        async function handleDetailAddToCart(e) {
            const userId = sessionStorage.getItem('userId');
            const isLogin = sessionStorage.getItem('isLogin') === 'true';

            if (!isLogin || !userId) {
                alert('Please log in to add items to your cart.');
                return;
            }

            const productId = e.target.getAttribute('data-product-id');
            const quantityInput = document.getElementById('quantity');
            const quantity = parseInt(quantityInput.value) || 1;

            if (!productId) return;

            const requestBody = {
                userId: userId,
                productId: parseInt(productId),
                quantity: quantity
            }; 

            try {
                // Mock API Logic
                const response = await fetch(ADD_TO_CART_MOCK_ENDPOINT);
                const data = await response.json();
                
                if (data.success) {
                    alert(`${quantity} of Product ID ${productId} added to cart successfully!`); 
                    
                    // Update Mock Cart Count (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Cart ‡πÅ‡∏•‡∏∞ Index)
                    let currentCount = parseInt(sessionStorage.getItem('mockCartCount') || '0');
                    currentCount += quantity;
                    sessionStorage.setItem('mockCartCount', currentCount.toString()); 
                    
                    // Update Header Display ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    const countElement = document.getElementById('cart-count');
                    if (countElement) countElement.textContent = currentCount.toString();
                    
                } else {
                    alert(data.message || "An error occurred. Out of stock?"); 
                }

            } catch (error) {
                alert('Server/Mock connection error. Cannot add item to cart.');
            }
        }
        
        // ----------------------------------------------------------------
        // 4. INITIALIZATION
        // ----------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            updateHeader();
            fetchAndRenderProductDetail(); 
        });
    </script> 
</body>
</html>