<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | WEBSITE NAME</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="checkout.css"> 
</head>
<body>

    <header class="main-header">
        <div class="logo">WEBSITE NAME</div>
        <nav class="auth-links" id="header-auth-links">
            </nav>
    </header>

    <main class="container">
        <h1 class="page-title">Checkout</h1>
        
        <form id="checkout-form" class="checkout-grid">
            
            <div class="checkout-forms">
                <div class="checkout-box" id="shipping-address-box">
                    <h2>1. Shipping Address</h2>
                    <p>Loading address...</p>
                    </div>

                <div class="checkout-box">
    <h2>2. Payment Method</h2>
    <div class="form-group">
        
        <div class="payment-option selected">
            <input type="radio" name="payment" value="mastercard" id="mc" checked>
            <label for="mc"></label>
            <div class="payment-icons">
                <img src="images/mastercard.png" alt="MasterCard" class="card-icon">
            </div>
            <p class="small-text">Secure payment via gateway</p>
        </div>
        
        <div class="payment-option">
            <input type="radio" name="payment" value="visa" id="visa">
            <label for="visa"></label>
            <div class="payment-icons">
                <img src="images/visa.png" alt="Visa" class="card-icon">
            </div>
            <p class="small-text">Secure payment via gateway</p>
        </div>

        <div class="payment-option">
            <input type="radio" name="payment" value="qr_payment" id="qr">
            <label for="qr"></label>
            <div class="payment-icons">
                <img src="images/promptpay.png" alt="QR Payment" class="card-icon qr-icon">
            </div>
            <p class="small-text">Pay upon receipt of goods</p>
        </div>
        
    </div>
</div>
            </div>

            <div class="cart-summary">
                <h2>Order Summary</h2>
                <div id="order-items-summary">
                    <p>Loading items...</p>
                </div>
                
                <div class="summary-line">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">0 ‡∏ø</span>
                </div>
                <div class="summary-line">
                    <span>Shipping</span>
                    <span id="summary-shipping">Free</span>
                </div>
                <div class="summary-line total">
                    <span>Total Payable</span>
                    <span id="summary-total">0 ‡∏ø</span>
                </div>
                
                <button type="submit" class="submit-btn final-checkout">Place Order</button>
            </div>

        </form>
    </main>
    
    <script>
        // API Endpoint ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
        const CHECKOUT_API = '/api/orders/checkout'; // API Path ‡∏ï‡∏≤‡∏° Task
        const MOCK_PROFILE_ENDPOINT = '/mock/profile.json'; // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        const MOCK_CART_ENDPOINT = '/mock/cart.json'; // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const SUCCESS_REDIRECT = 'cart.html'; // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ cart.html (‡∏ï‡∏≤‡∏° Task)
        const LOGIN_PAGE = 'login.html';

        // ----------------------------------------------------------------
        // 1. DATA RENDERING & HEADER LOGIC (reuse existing logic)
        // ----------------------------------------------------------------
        function updateHeader() {
            // (‡πÉ‡∏ä‡πâ Logic ‡∏à‡∏≤‡∏Å cart.html ‡∏´‡∏£‡∏∑‡∏≠ index.html ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
            const username = sessionStorage.getItem('username');
            const isLogin = sessionStorage.getItem('isLogin') === 'true';
            const linksContainer = document.getElementById('header-auth-links');

            linksContainer.innerHTML = ''; 

            if (isLogin) {
                linksContainer.innerHTML = `
                    <a href="index.html" class="nav-link">HOME</a>
                    <a href="order-history.html" class="nav-link">Order History</a>
                    <a href="profile.html" class="nav-link">${username} üë§</a>
                    <a href="cart.html" class="nav-link cart-icon">üõí</a> 
                `;
            } else {
                window.location.href = LOGIN_PAGE; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Login ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Checkout ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            }
        }
        
        async function fetchAddressAndSummary() {
            const userId = sessionStorage.getItem('userId');
            const addressBox = document.getElementById('shipping-address-box');
            const itemsSummary = document.getElementById('order-items-summary');
            
            // Fetch Address (Mock)
            try {
                const profileResponse = await fetch(MOCK_PROFILE_ENDPOINT);
                const profileData = await profileResponse.json();
                
                addressBox.innerHTML = `
                    <h2>1. Shipping Address</h2>
                    <p><strong>${profileData.fullName}</strong> (${profileData.phone})</p>
                    <p>${profileData.userAddress}</p>
                    <p style="margin-top: 10px;">(Address Mocked from /mock/profile.json)</p>
                `;
            } catch (e) {
                addressBox.innerHTML = `<h2>1. Shipping Address</h2><p style="color:red;">Error loading address mock data.</p>`;
            }

            // Fetch Cart Summary (Mock)
            try {
                const cartResponse = await fetch(MOCK_CART_ENDPOINT);
                const cartItems = await cartResponse.json();
                
                let subtotal = 0;
                itemsSummary.innerHTML = '<ul>';
                cartItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    itemsSummary.innerHTML += `<li>${item.name} x ${item.quantity} (${itemTotal.toLocaleString()} ‡∏ø)</li>`;
                });
                itemsSummary.innerHTML += '</ul>';

                document.getElementById('summary-subtotal').textContent = subtotal.toLocaleString() + ' ‡∏ø';
                document.getElementById('summary-total').textContent = subtotal.toLocaleString() + ' ‡∏ø';
                
            } catch (e) {
                 itemsSummary.innerHTML = '<p style="color:red;">Error loading cart summary mock data.</p>';
            }
        }

        // ----------------------------------------------------------------
        // 2. CHECKOUT LOGIC (POST API)
        // ----------------------------------------------------------------

        async function handleCheckout(e) {
            e.preventDefault();
            const userId = sessionStorage.getItem('userId');
            
            // Mock Body: ‡∏™‡πà‡∏á userId ‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            const requestBody = { userId: userId };
            
            // --- Mock Logic: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ---
            
            // Scenario 1: Mock Error 400/404/409
            if (userId === '000') {
                 // Mock 400 Bad Request
                 alert('Order failed: Your cart is no longer valid (Mock 400).');
                 return;
            }

            // Mock Success
            try {
                 // Simulate API POST
                 console.log(`Mock POST to ${CHECKOUT_API} with body:`, requestBody);
                 
                 setTimeout(() => {
                    // Success: ‡πÅ‡∏™‡∏î‡∏á alert ‡πÅ‡∏•‡∏∞ redirect
                    alert("Order placed successfully!");
                    window.location.href = SUCCESS_REDIRECT; 
                 }, 1000);

            } catch (error) {
                // Network error (in real scenario)
                alert("An unexpected error occurred. Please try again."); 
            }
        }

        // ----------------------------------------------------------------
        // 3. INITIALIZATION
        // ----------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isLogin') !== 'true') {
                 window.location.href = LOGIN_PAGE; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Login
                 return;
            }
            
            updateHeader();
            fetchAddressAndSummary();

            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', handleCheckout);
            }
        });
    </script> 
</body>
</html>